from langgraph.graph import StateGraph, START, END
from typing_extensions import TypedDict, Literal, Annotated, List
import operator
from pydantic import BaseModel, Field


class feedback_score(BaseModel):

    score: Literal[1,2,3,4,5,6,7,8,9,10] = Field(default=None, description="Score from 1 to 10 to assay.")
    justification: str = Field(default=None, description="Why the score is given and what is missing from the assay to make it better.")


class State(TypedDict):
    topic: str
    assay: str
    feedback_cot: Annotated[str, Field(description="Clarity of thought feedback on the essay.")]
    score_cot: Annotated[int, Field(description="Clarity of thought Score on the essay.")]
    feedback_doa: Annotated[str, Field(description="Depth of analysis feedback on the essay.")]
    score_doa: Annotated[int, Field(description="Depth of analysis Score on the essay.")]
    feedback_language: Annotated[str, Field(description="Language and grammar feedback on the essay.")]
    score_language: Annotated[int, Field(description="Language and grammar Score on the essay.")]
    final_feedback: Annotated[str, Field(description="Feedback summarizer after incorporating feedbacks from cot, doa, language.")]
    final_avg_score: Annotated[float, Field(description="Average score from cot, doa, language.")]

def generate_assay(state: State):
    p = f"Generate detailed essay on the topic: {state['topic']}. Please make it atleast 500 words. Please use markdown formatting for the essay."
    result = llm.invoke(p)
    return {'assay': result.content}

def feedback_clarity_of_thought(state: State):
    structured_llm = llm.with_structured_output(feedback_score)
    p = f"Provide feedback to the generated assay based on clarity of thought. Essay: {state['assay']}. Please provide score from 1 to 10 and justification for the score. Moreover, explain what can be done to improve clarity of thought in the essay."
    response = structured_llm.invoke(p)
    state['feedback_cot'] = response.justification
    state['score_cot'] = response.score
    return state

def feedback_depth_of_analysis(state: State):
    structured_llm = llm.with_structured_output(feedback_score)
    p = f"Provide feedback to the generated assay based on depth of analysis. Essay: {state['assay']}. Please provide score from 1 to 10 and justification for the score. Moreover, explain what can be done to improve depth of analysis in the essay."
    response = structured_llm.invoke(p)
    state['feedback_doa'] = response.justification
    state['score_doa'] = response.score
    return state

def feedback_language_grammar(state: State):
    structured_llm = llm.with_structured_output(feedback_score)
    p = f"Provide feedback to the generated assay based on language and grammar. Essay: {state['assay']}. Please provide score from 1 to 10 and justification for the score. Moreover, explain what can be done to improve language and grammar in the essay."
    response = structured_llm.invoke(p)
    state['feedback_language'] = response.justification
    state['score_language'] = response.score
    return state


def final_summarizer(state: State):
    avg_score = (state['score_cot'] + state['score_doa'] + state['score_language']) / 3
    state['final_avg_score'] = avg_score
    p = f"Summarize the feedbacks provided for the essay: \n{state['assay']}.\n\n\nPlease incorporate feedbacks from clarity of thought: \n{state['feedback_cot']}, \n\n\ndepth of analysis: \n{state['feedback_doa']}, \n\n\nlanguage and grammar: \n{state['feedback_language']} to provide final feedback to improve the essay."
    result = llm.invoke(p)
    state['final_feedback'] = result.content
    return state



workflow = StateGraph(State)
workflow.add_node("generate_assay", generate_assay)
workflow.add_node("feedback_clarity_of_thought", feedback_clarity_of_thought)
workflow.add_node("feedback_depth_of_analysis", feedback_depth_of_analysis)
workflow.add_node("feedback_language_grammar", feedback_language_grammar)
workflow.add_node("final_summarizer",final_summarizer)

workflow.add_edge(START, "generate_assay")
workflow.add_edge("generate_assay","feedback_clarity_of_thought")
workflow.add_edge("generate_assay","feedback_depth_of_analysis")
workflow.add_edge("generate_assay","feedback_language_grammar")

workflow.add_edge("feedback_clarity_of_thought", "final_summarizer")
workflow.add_edge("feedback_depth_of_analysis", "final_summarizer")
workflow.add_edge("feedback_language_grammar", "final_summarizer")
workflow.add_edge("final_summarizer", END)

chain = workflow.compile()
result = chain.invoke({"topic":"digital fraud"})
